<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

        <title>Allearn - แอดมิน</title>
    
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background: #f5f7fa;
            background-image: linear-gradient(#e0e7ef 1px, transparent 1px);
            background-size: 100% 40px;
            margin: 0; padding: 0; color: #333;
        }
        .header {
            background-color: #ffffff; height: 75px; display: flex;
            align-items: center; padding: 0 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 100;
        }
        .logo { height: 45px; object-fit: contain; }
        .header-title {
            margin-left: 20px; font-size: 20px; font-weight: 600;
            color: #1f3c88; border-left: 2px solid #f7d046; padding-left: 20px;
        }
        .stats-wrapper {
            max-width: 1100px; margin: 40px auto 20px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; padding: 0 20px;
        }
        .stat-card {
            background: white; padding: 25px; border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center;
            text-align: center; border-bottom: 5px solid #2f6bff;
            cursor: pointer; transition: 0.3s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card.yellow-border { border-color: #f7d046; }
        .stat-label { font-size: 16px; color: #4a7599; font-weight: 500; margin-bottom: 5px; }
        .stat-value { font-size: 36px; font-weight: 600; color: #1f3c88; }

        .content-white {
            background: rgba(255, 255, 255, 0.95); padding: 50px 20px;
            border-radius: 60px 60px 0 0; max-width: 1200px;
            margin: 40px auto 0; min-height: 600px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.03);
        }
        .section-title { color: #1f3c88; font-size: 24px; margin-bottom: 30px; text-align: center; }
        .table-container {
            overflow-x: auto; background: white; border-radius: 20px;
            padding: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.02);
        }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { color: #4a7599; font-size: 15px; font-weight: 500; padding: 18px 25px; border-bottom: 2px solid #f5f7fa; }
        td { padding: 18px 25px; font-size: 15px; border-bottom: 1px solid #f5f7fa; color: #333; }
        
        .role-select {
            padding: 5px 10px; border-radius: 10px; border: 1px solid #ddd;
            font-family: 'Kanit'; cursor: pointer; background: white;
        }
        .btn {
            font-family: 'Kanit', sans-serif; padding: 8px 18px; border-radius: 20px;
            font-size: 14px; font-weight: 500; cursor: pointer; border: none; transition: 0.2s;
            text-decoration: none; display: inline-flex; align-items: center;
        }
        .btn-view { background-color: #e6ecf5; color: #1f3c88; margin-right: 8px; }
        .btn-view:hover { background-color: #2f6bff; color: white; }
        .btn-delete { background-color: #fff0f0; color: #d93025; }
        .btn-delete:hover { background-color: #d93025; color: white; }
        
        .status-loading { text-align: center; padding: 50px; color: #4a7599; }
        .text-center { text-align: center; }
    </style>
</head>
<body>

<header class="header">
    <a href="index.html"><img src="logolearn.png" alt="Logo" class="logo"></a>
    <div class="header-title">Management Dashboard</div>
</header>

<div class="stats-wrapper">
    <div class="stat-card" onclick="switchTab('users')">
        <span class="stat-label">จำนวนผู้ใช้งานทั้งหมด</span>
        <span id="userCount" class="stat-value">...</span>
    </div>
    <div class="stat-card yellow-border" onclick="switchTab('sheets')">
        <span class="stat-label">จำนวนชีททั้งหมด</span>
        <span id="sheetCount" class="stat-value">...</span>
    </div>
</div>

<div class="content-white">
    <h2 class="section-title" id="tableTitle">จัดการข้อมูลผู้ใช้งาน</h2>
    <div class="table-container">
        <table id="mainTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody">
                <tr><td colspan="5" class="status-loading">กำลังเรียกข้อมูล...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const _supabase = supabase.createClient(
        "https://ctfrqwehpvpldtiojedb.supabase.co",
        "sb_publishable_YHDQnG7VsNgb4O4i6MPN5g_lgU5eOGI"
    );

    const BUCKET_NAME = 'sheet-pdf';
    let currentTab = 'users';

    async function updateStats() {
        const { count: uCount } = await _supabase.from('Account').select('*', { count: 'exact', head: true });
        const { count: sCount } = await _supabase.from('Sheet').select('*', { count: 'exact', head: true });
        document.getElementById('userCount').innerText = uCount || 0;
        document.getElementById('sheetCount').innerText = sCount || 0;
    }

    function switchTab(tab) {
        currentTab = tab;
        loadData();
    }

    async function loadData() {
        updateStats();
        const tableBody = document.getElementById('tableBody');
        const tableHead = document.getElementById('tableHead');
        const tableTitle = document.getElementById('tableTitle');
        
        tableBody.innerHTML = '<tr><td colspan="5" class="status-loading">กำลังเรียกข้อมูล...</td></tr>';

        if (currentTab === 'users') {
            tableTitle.innerText = "จัดการข้อมูลผู้ใช้งาน";
            tableHead.innerHTML = `<tr><th>Username</th><th>ชื่อ-นามสกุล</th><th class="text-center">ชีทที่อัพโหลด</th><th style="text-align:right;">บทบาท</th></tr>`;
            
            const { data } = await _supabase
                .from('Account')
                .select('*, Sheet(count)')
                .order('role', { ascending: true });
            
            tableBody.innerHTML = (data || []).map(user => `
                <tr>
                    <td><span style="color:#f06292;">@${user.auser || '-'}</span></td>
                    <td>${user.name} ${user.surname}</td>
                    <td class="text-center">${user.Sheet[0]?.count || 0}</td> 
                    <td style="text-align:right;">
                        <select class="role-select" onchange="updateRole('${user.idacc}', this.value)">
                            <option value="Admin" ${user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>user</option>
                        </select>
                    </td>
                </tr>
            `).join('');

        } else {
            tableTitle.innerText = "รายการชีทสรุปบทเรียน";
            tableHead.innerHTML = `<tr><th>เจ้าของ</th><th>ชื่อชีท</th><th>วิชา</th><th style="text-align:right;">การจัดการ</th></tr>`;
            
            const { data } = await _supabase.from('Sheet').select('*, Account(name, surname), Subject(subject_name)');

            tableBody.innerHTML = (data || []).map(item => {
                const { data: urlData } = _supabase.storage.from(BUCKET_NAME).getPublicUrl(item.file_path);

                return `
                    <tr>
                        <td style="font-weight: 500;">${item.Account ? item.Account.name + ' ' + item.Account.surname : '-'}</td>
                        <td style="color: #1f3c88;">${item.sheet_name}</td>
                        <td><span style="background:#fff9e6; padding:4px 12px; border-radius:15px; font-size:13px;">${item.Subject?.subject_name || '-'}</span></td>
                        <td style="text-align: right; white-space: nowrap;">
                            <a href="${urlData.publicUrl}" target="_blank" class="btn btn-view">ดูไฟล์</a>
                            <button class="btn btn-delete" onclick="deleteSheet('${item.idsheet}', '${item.file_path}', '${item.sheet_name}')">ลบ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    }

    async function updateRole(userId, newRole) {
        await _supabase.from('Account').update({ role: newRole }).eq('idacc', userId);
        loadData(); 
    }

    async function deleteSheet(idsheet, filePath, sheetName) {
        if (!confirm(`ยืนยันการลบ "${sheetName}"?`)) return;
        try {
            await _supabase.from('comment').delete().eq('idsheet', idsheet);
            await _supabase.from('favsheet').delete().eq('idsheet', idsheet);
            await _supabase.from('Favorite').delete().eq('idsheet', idsheet);
            
            const { error } = await _supabase.from('Sheet').delete().eq('idsheet', idsheet);
            if (error) throw error;

            if (filePath) {
                await _supabase.storage.from(BUCKET_NAME).remove([filePath]);
            }

            alert("ลบสำเร็จ");
            loadData();
        } catch (e) {
            alert("ผิดพลาด: " + e.message);
        }
    }

    switchTab('users');
</script>
</body>
</html>