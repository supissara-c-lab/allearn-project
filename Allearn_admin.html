<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Allearn</title>
    <style>
        :root {
            --primary-color: #1f3c88;
            --accent-color: #f7d046;
            --secondary-color: #4a7599;
            --bg-color: #f5f7fa;
            --danger-color: #d93025;
        }

        body { font-family: 'Kanit', sans-serif; background: var(--bg-color); margin: 0; padding: 0; color: #333; }
        
        /* Header ปรับให้ยืดหยุ่น */
        .header { 
            background-color: #ffffff; 
            min-height: 75px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 5%; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            flex-wrap: wrap;
        }
        .header-left { display: flex; align-items: center; padding: 10px 0; }
        .logo { height: 45px; cursor: pointer; }
        .header-title { margin-left: 20px; font-size: 18px; font-weight: 600; color: var(--primary-color); border-left: 2px solid var(--accent-color); padding-left: 20px; }
        
        .user-session-info { display: flex; flex-direction: column; align-items: flex-end; line-height: 1.2; padding: 10px 0; }
        .session-user { font-weight: 600; color: var(--primary-color); font-size: 14px; }
        .session-role { font-size: 12px; color: var(--secondary-color); background: #eef2ff; padding: 2px 8px; border-radius: 10px; margin-top: 2px; }

        /* การจัดการ Grid สำหรับสถิติ */
        .stats-wrapper { 
            max-width: 1100px; 
            margin: 30px auto; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            padding: 0 20px; 
        }
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: 25px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            border-bottom: 5px solid #2f6bff; 
            cursor: pointer; 
            transition: 0.3s transform ease; 
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card.yellow-border { border-color: var(--accent-color); }
        .stat-label { font-size: 16px; color: var(--secondary-color); margin-bottom: 5px; }
        .stat-value { font-size: 36px; font-weight: 600; color: var(--primary-color); }

        /* ส่วนเนื้อหาหลัก */
        .content-white { 
            background: white; 
            padding: 40px 20px; 
            border-radius: 40px 40px 0 0; 
            max-width: 1200px; 
            margin: 20px auto 0; 
            min-height: 600px; 
        }
        .section-title { color: var(--primary-color); font-size: 22px; margin-bottom: 30px; text-align: center; }
        
        /* ตารางแบบ Responsive */
        .table-container { overflow-x: auto; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { color: var(--secondary-color); font-size: 14px; padding: 15px; border-bottom: 2px solid #f5f7fa; text-align: left; background: #fafbfc; }
        td { padding: 15px; font-size: 14px; border-bottom: 1px solid #f5f7fa; vertical-align: middle; }
        
        .role-select { padding: 6px 12px; border-radius: 8px; border: 1px solid #ddd; font-family: 'Kanit'; cursor: pointer; outline: none; }
        .btn { font-family: 'Kanit'; padding: 8px 16px; border-radius: 15px; font-size: 13px; cursor: pointer; border: none; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-view { background-color: #e6ecf5; color: var(--primary-color); margin-right: 5px; }
        .btn-delete { background-color: #fff0f0; color: var(--danger-color); }
        .btn:hover { opacity: 0.8; }

        .action-link { position: relative; color: #ccc; font-size: 20px; transition: 0.3s; text-decoration: none; display: inline-block; }
        .action-link:hover { color: var(--primary-color); }
        .red-dot { 
            position: absolute; top: -2px; right: -2px; 
            width: 10px; height: 10px; 
            background-color: #ff4757; border-radius: 50%; 
            border: 2px solid white; display: none;
        }
        .status-loading { text-align: center; padding: 50px; color: var(--secondary-color); }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .header { justify-content: center; text-align: center; padding: 15px; }
            .header-left { flex-direction: column; }
            .header-title { border-left: none; border-top: 2px solid var(--accent-color); margin-left: 0; margin-top: 10px; padding-left: 0; padding-top: 10px; }
            .user-session-info { align-items: center; width: 100%; }
            .content-white { border-radius: 20px 20px 0 0; padding-top: 20px; }
        }
    </style>
</head>
<body>

<header class="header">
    <div class="header-left">
        <img src="logolearn.png" alt="Logo" class="logo" onclick="window.location.href='Allearn_profile.html'">
        <div class="header-title">ระบบบริหารจัดการข้อมูลสารสนเทศ</div>
    </div>
    <div class="user-session-info" id="sessionDisplay">
        <span class="session-user" id="currentAuser">กำลังตรวจสอบข้อมูล...</span>
        <span class="session-role" id="currentRole">กรุณารอสักครู่</span>
    </div>
</header>

<div class="stats-wrapper">
    <div class="stat-card" onclick="switchTab('users')">
        <span class="stat-label">บัญชีผู้ใช้งานในระบบ</span>
        <span id="userCount" class="stat-value">0</span>
    </div>
    <div class="stat-card yellow-border" onclick="switchTab('sheets')">
        <span class="stat-label">เอกสารสรุปบทเรียนทั้งหมด</span>
        <span id="sheetCount" class="stat-value">0</span>
    </div>
</div>

<div class="content-white">
    <h2 class="section-title" id="tableTitle">การจัดการข้อมูลสมาชิก</h2>
    <div class="table-container">
        <table id="mainTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody">
                <tr><td colspan="5" class="status-loading">กำลังดำเนินการเรียกข้อมูลจากระบบ...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const _supabase = supabase.createClient(
        "https://ctfrqwehpvpldtiojedb.supabase.co",
        "sb_publishable_YHDQnG7VsNgb4O4i6MPN5g_lgU5eOGI"
    );

    const BUCKET_NAME = 'sheet-pdf';
    let currentTab = 'users';
    const IDACC = sessionStorage.getItem("idacc");
    const VIEWED_SHEETS_KEY = 'allearn_viewed_sheets';

    async function checkAdminAuth() {
        if (!IDACC) {
            alert("ระบบไม่พบข้อมูลการเข้าใช้งาน หรือเซสชันหมดอายุ กรุณาเข้าสู่ระบบอีกครั้ง");
            window.location.href = "Allearn_login.html";
            return;
        }
        const { data, error } = await _supabase.from("Account").select("auser, role").eq("idacc", IDACC).single();
        if (error || !data) {
            window.location.href = "Allearn_login.html";
            return;
        }
        document.getElementById('currentAuser').innerText = "ผู้ใช้งาน: @" + data.auser;
        document.getElementById('currentRole').innerText = "ระดับสิทธิ์: " + (data.role === "Admin" ? "ผู้ดูแลระบบ" : data.role);
        
        if (data.role !== "Admin") {
            alert("ขออภัย คุณไม่ได้รับอนุญาตให้เข้าถึงส่วนบริหารจัดการระบบ");
            window.location.href = "Allearn_profile.html";
        }
    }

    async function updateStats() {
        const { count: uCount } = await _supabase.from('Account').select('*', { count: 'exact', head: true });
        const { count: sCount } = await _supabase.from('Sheet').select('*', { count: 'exact', head: true });
        document.getElementById('userCount').innerText = uCount || 0;
        document.getElementById('sheetCount').innerText = sCount || 0;
    }

    function switchTab(tab) {
        currentTab = tab;
        loadData();
    }

    function markSheetAsViewed(idsheet) {
        let viewed = JSON.parse(localStorage.getItem(VIEWED_SHEETS_KEY) || "[]");
        if (!viewed.includes(idsheet.toString())) {
            viewed.push(idsheet.toString());
            localStorage.setItem(VIEWED_SHEETS_KEY, JSON.stringify(viewed));
        }
    }

    async function loadData() {
        updateStats();
        const tableBody = document.getElementById('tableBody');
        const tableHead = document.getElementById('tableHead');
        const tableTitle = document.getElementById('tableTitle');
        
        tableBody.innerHTML = '<tr><td colspan="6" class="status-loading">กำลังดำเนินการเรียกข้อมูล...</td></tr>';

        if (currentTab === 'users') {
            tableTitle.innerText = "การจัดการข้อมูลสมาชิก";
            tableHead.innerHTML = `<tr><th>ชื่อผู้ใช้งาน</th><th>ชื่อ-นามสกุล</th><th style="text-align:center;">จำนวนเอกสาร</th><th style="text-align:right;">กำหนดบทบาท</th></tr>`;
            
            const { data } = await _supabase.from('Account').select('*, Sheet(count)').order('role', { ascending: true });
            
            tableBody.innerHTML = (data || []).map(user => `
                <tr>
                    <td><span style="color:#f06292; font-weight:500;">@${user.auser || '-'}</span></td>
                    <td>${user.name} ${user.surname}</td>
                    <td style="text-align:center;">${user.Sheet && user.Sheet[0] ? user.Sheet[0].count : 0}</td> 
                    <td style="text-align:right;">
                        <select class="role-select" onchange="updateRole('${user.idacc}', this.value)">
                            <option value="Admin" ${user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                        </select>
                    </td>
                </tr>
            `).join('');

        } else {
            tableTitle.innerText = "การจัดการเอกสารประกอบการเรียน";
            tableHead.innerHTML = `<tr><th>เจ้าของเอกสาร</th><th>ชื่อเอกสาร</th><th>รายวิชา</th><th style="text-align:right;">การจัดการ</th><th style="width:40px;"></th></tr>`;
            
            const { data } = await _supabase.from('Sheet').select('*, Account(name, surname), Subject(subject_name)').order('idsheet', { ascending: false });
            const viewedSheets = JSON.parse(localStorage.getItem(VIEWED_SHEETS_KEY) || "[]");

            tableBody.innerHTML = (data || []).map(item => {
                const { data: urlData } = _supabase.storage.from(BUCKET_NAME).getPublicUrl(item.file_path);
                const isNew = !viewedSheets.includes(item.idsheet.toString());
                
                return `
                    <tr>
                        <td style="font-weight: 500;">${item.Account ? item.Account.name + ' ' + item.Account.surname : 'ไม่พบข้อมูล'}</td>
                        <td style="color: var(--primary-color);">${item.sheet_name}</td>
                        <td><span style="background:#fff9e6; padding:4px 12px; border-radius:15px; font-size:12px; color:#856404;">${item.Subject?.subject_name || '-'}</span></td>
                        <td style="text-align: right; white-space: nowrap;">
                            <a href="${urlData.publicUrl}" target="_blank" class="btn btn-view">ตรวจสอบไฟล์</a>
                            <button class="btn btn-delete" onclick="deleteSheet('${item.idsheet}', '${item.file_path}', '${item.sheet_name}')">ลบข้อมูล</button>
                        </td>
                        <td style="text-align: center;">
                            <a href="Allearn_content.html?idsheet=${item.idsheet}" 
                               class="action-link" 
                               onclick="markSheetAsViewed('${item.idsheet}')">
                                <i class="fa-solid fa-circle-chevron-right"></i>
                                <div class="red-dot" style="display: ${isNew ? 'block' : 'none'}"></div>
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }
    }

    async function updateRole(userId, newRole) {
        const { error } = await _supabase.from('Account').update({ role: newRole }).eq('idacc', userId);
        if (error) {
            alert("ไม่สามารถปรับเปลี่ยนสิทธิ์ได้: " + error.message);
        }
        loadData(); 
    }

    async function deleteSheet(idsheet, filePath, sheetName) {
        if (!confirm(`ยืนยันการลบเอกสาร "${sheetName}" ออกจากระบบอย่างถาวรใช่หรือไม่?`)) return;
        try {
            await _supabase.from('comment').delete().eq('idsheet', idsheet);
            await _supabase.from('favsheet').delete().eq('idsheet', idsheet);
            const { error } = await _supabase.from('Sheet').delete().eq('idsheet', idsheet);
            if (error) throw error;
            if (filePath) await _supabase.storage.from(BUCKET_NAME).remove([filePath]);
            
            alert("ดำเนินการลบข้อมูลเรียบร้อยแล้ว");
            loadData();
        } catch (e) { 
            alert("เกิดข้อผิดพลาดในการลบข้อมูล: " + e.message); 
        }
    }

    checkAdminAuth().then(loadData);
</script>
</body>
</html>