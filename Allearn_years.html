<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Allearn_header.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <title>Allearn - รายการเอกสารประกอบการเรียน</title>

    <style>
        :root {
            --primary-blue: #1f3c88;
            --secondary-blue: #4a7599;
            --accent-yellow: #f7d046;
            --bg-gray: #f5f7fa;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: var(--bg-gray);
            margin: 0;
            background-image: linear-gradient(#e0e7ef 1px, transparent 1px);
            background-size: 100% 40px;
            overflow-x: hidden;
        }

        /* ===== TITLE SECTION ===== */
        .page-title {
            max-width: 1100px;
            margin: 40px auto 20px;
            padding: 40px 20px;
            background: var(--white);
            border-radius: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .page-title h1 { 
            margin: 0 0 10px; 
            color: var(--primary-blue); 
            font-size: clamp(24px, 5vw, 32px); 
            font-weight: 600;
        }
        .page-title p { 
            margin: 0 0 15px; 
            color: var(--secondary-blue); 
            font-size: clamp(14px, 3vw, 16px);
        }

        .subject-tags-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .subject-filter-tag {
            background: #e0e7ef; 
            color: var(--secondary-blue); 
            padding: 8px 18px; 
            border-radius: 50px;
            font-size: 13px; 
            font-weight: 500; 
            border: none; 
            cursor: pointer; 
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .subject-filter-tag:hover { background: #d1d9e6; transform: translateY(-2px); }
        .subject-filter-tag.active {
            background: var(--accent-yellow); 
            color: var(--primary-blue); 
            box-shadow: 0 4px 12px rgba(247, 208, 70, 0.3);
            font-weight: 600; 
            transform: translateY(-2px);
        }

        /* ===== SHEET GRID SECTION ===== */
        .sheet-section { 
            max-width: 1200px; 
            margin: 30px auto 60px; 
            padding: 0 20px; 
        }
        .sheet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        .sheet-card {
            background: var(--white); 
            border-radius: 20px; 
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            overflow: hidden; 
            text-decoration: none; 
            color: inherit; 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0,0,0,0.03);
        }
        .sheet-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 12px 25px rgba(0,0,0,0.1); 
        }
        .sheet-thumb { 
            height: 180px; 
            background: #e6ecf5; 
            overflow: hidden;
        }
        .sheet-thumb img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        .sheet-body { padding: 20px; flex-grow: 1; }
        .sheet-tag {
            display: inline-block; 
            background: var(--accent-yellow); 
            color: var(--primary-blue); 
            padding: 4px 12px;
            border-radius: 50px; 
            font-size: 11px; 
            margin-bottom: 12px; 
            font-weight: 600;
        }

        .sheet-title-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }
        .sheet-body h3 { 
            font-size: 16px; 
            margin: 0; 
            color: var(--primary-blue); 
            line-height: 1.5; 
            flex: 1; 
            font-weight: 500;
        }
        
        .sheet-fav-count {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: #ff4757;
            font-weight: 600;
            padding-top: 2px;
        }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .page-title { margin: 20px 10px; padding: 30px 15px; border-radius: 20px; }
            .sheet-grid { grid-template-columns: 1fr; }
            .sheet-section { padding: 0 15px; }
        }
    </style>
</head>

<body>

<div id="header"></div>

<section class="page-title">
    <h1 id="yearTitle">กำลังดำเนินการจัดเตรียมข้อมูล...</h1>
    <p id="yearSubtitle">กรุณารอสักครู่</p>
    <div id="subjectTags" class="subject-tags-container"></div>
</section>

<section class="sheet-section">
    <div class="sheet-grid" id="sheetGrid">
        <p style="text-align:center; grid-column: 1/-1; color: var(--secondary-blue); padding: 50px;">กำลังตรวจสอบข้อมูลเอกสารในชั้นปีนี้...</p>
    </div>
</section>

<script>
    const supabaseClient = supabase.createClient(
        'https://ctfrqwehpvpldtiojedb.supabase.co',
        'sb_publishable_YHDQnG7VsNgb4O4i6MPN5g_lgU5eOGI'
    );

    // ดึง Header และเริ่มต้นระบบค้นหา
    fetch("Allearn_header.html").then(r => r.text()).then(t => {
        document.getElementById("header").innerHTML = t;
        initSearchDropdown();
    });

    function initSearchDropdown() {
        const sInput = document.getElementById('headerSearchInput');
        const sDropdown = document.getElementById('headerSearchDropdown');
        if (!sInput) return;
        sInput.addEventListener('focus', () => { sDropdown.classList.add('show'); loadSearchQuickTags(); });
        document.addEventListener('click', (e) => { if (!e.target.closest('.search-container')) sDropdown.classList.remove('show'); });
    }

    async function loadSearchQuickTags() {
        const subList = document.getElementById('searchSubjectList');
        const profList = document.getElementById('searchProfessorList');
        try {
            const [{ data: subs }, { data: profs }] = await Promise.all([
                supabaseClient.from("Subject").select("idsubject, subject_name, idyear").limit(8),
                supabaseClient.from("Professor").select("idprofessor, name").limit(8)
            ]);
            if (subs && subList) subList.innerHTML = subs.map(s => `<a href="Allearn_years.html?idyear=${s.idyear}&target_sub=${s.idsubject}" class="search-tag-link">${s.subject_name}</a>`).join('');
            if (profs && profList) profList.innerHTML = profs.map(p => `<a href="Allearn_professor.html?id=${p.idprofessor}" class="search-tag-link">${p.name}</a>`).join('');
        } catch (e) { console.error("Error loading quick tags:", e); }
    }

    const params = new URLSearchParams(window.location.search);
    const IDYEAR = params.get("idyear");
    const TARGET_SUB = params.get("target_sub");
    const yearMap = { Y01: "นักศึกษาชั้นปีที่ 1", Y02: "นักศึกษาชั้นปีที่ 2", Y03: "นักศึกษาชั้นปีที่ 3", Y04: "นักศึกษาชั้นปีที่ 4" };

    const titleEl = document.getElementById("yearTitle");
    const subEl = document.getElementById("yearSubtitle");
    const subjectTagsEl = document.getElementById("subjectTags");
    const grid = document.getElementById("sheetGrid");
    let allSheets = []; 

    // เริ่มต้นตรวจสอบข้อมูลชั้นปี
    if (!IDYEAR || !yearMap[IDYEAR]) {
        titleEl.textContent = "ไม่พบข้อมูลชั้นปีที่ระบุ";
        subEl.textContent = "กรุณาตรวจสอบการเลือกชั้นปีใหม่อีกครั้ง";
        grid.innerHTML = "";
    } else {
        titleEl.textContent = yearMap[IDYEAR];
        subEl.textContent = "รายวิชาทั้งหมดที่เปิดสอนในชั้นปีนี้"; 
        loadData();
    }

    /**
     * โหลดข้อมูลรายวิชาและเอกสารประกอบการเรียน
     */
    async function loadData() {
        try {
            const { data: subjects } = await supabaseClient.from("Subject").select("idsubject, subject_name").eq("idyear", IDYEAR);

            if (subjects && subjects.length > 0) {
                // สร้างปุ่มตัวกรองรายวิชา
                let tagsHtml = `<button class="subject-filter-tag active" id="btn-all" onclick="filterBySubject('all', this)">รายวิชาทั้งหมด</button>`;
                tagsHtml += subjects.map(s => `<button class="subject-filter-tag" id="btn-${s.idsubject}" onclick="filterBySubject('${s.idsubject}', this)">${s.subject_name}</button>`).join('');
                subjectTagsEl.innerHTML = tagsHtml;
                
                const subjectIds = subjects.map(s => s.idsubject);

                // ดึงข้อมูลชีทพร้อมจำนวนการถูกใจ (FavCount)
                const { data: sheets, error: sheetErr } = await supabaseClient
                    .from("Sheet")
                    .select(`idsheet, sheet_name, idsubject, sheet_cover, Subject (subject_name), favsheet(count)`)
                    .in("idsubject", subjectIds)
                    .order("idsheet", { ascending: false });

                if (sheetErr) throw sheetErr;
                
                allSheets = sheets;
                displaySheets(allSheets); 

                // กรณีมีการส่งค่า target_sub มาจากหน้าอื่นให้กดฟิลเตอร์ให้อัตโนมัติ
                if (TARGET_SUB) {
                    const targetBtn = document.getElementById(`btn-${TARGET_SUB}`);
                    if (targetBtn) filterBySubject(TARGET_SUB, targetBtn);
                }
            } else {
                grid.innerHTML = "<p style='grid-column:1/-1; text-align:center; color:#888; padding: 50px;'>ไม่พบข้อมูลรายวิชาในฐานข้อมูล</p>";
            }
        } catch (err) { 
            console.error("Data loading error:", err); 
            grid.innerHTML = "<p style='grid-column:1/-1; text-align:center; color:#d93025; padding: 50px;'>เกิดข้อผิดพลาดในการเชื่อมต่อข้อมูล</p>";
        }
    }

    /**
     * แสดงผลรายการชีทลงบน Grid
     */
    function displaySheets(sheetsToDisplay) {
        if (!sheetsToDisplay || sheetsToDisplay.length === 0) {
            grid.innerHTML = "<p style='grid-column:1/-1; text-align:center; color:#888; padding: 50px;'>ยังไม่มีเอกสารสรุปบทเรียนสำหรับหมวดหมู่นี้</p>";
            return;
        }

        grid.innerHTML = sheetsToDisplay.map(s => {
            const likeCount = s.favsheet?.[0]?.count || 0;
            return `
                <a href="Allearn_content.html?idsheet=${s.idsheet}" class="sheet-card">
                    <div class="sheet-thumb">
                        <img src="${s.sheet_cover || 'Exsheet.png'}" onerror="this.src='Exsheet.png'" alt="${s.sheet_name}">
                    </div>
                    <div class="sheet-body">
                        <span class="sheet-tag">${s.Subject?.subject_name || "วิชาทั่วไป"}</span>
                        <div class="sheet-title-row">
                            <h3>${s.sheet_name}</h3>
                            <div class="sheet-fav-count">
                                <i class="fa-solid fa-heart"></i>
                                <span>${likeCount}</span>
                            </div>
                        </div>
                    </div>
                </a>
            `;
        }).join('');
    }

    /**
     * ฟังก์ชันกรองข้อมูลตามรายวิชา
     */
    function filterBySubject(subjectId, btnElement) {
        document.querySelectorAll('.subject-filter-tag').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
        const filtered = (subjectId === 'all') ? allSheets : allSheets.filter(s => s.idsubject === subjectId);
        displaySheets(filtered);
    }
</script>

</body>
</html>