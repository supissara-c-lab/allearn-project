<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<title>Allearn</title>

<style>
    :root {
        --card-bg: #FFF9E5;
        --primary-blue: #1f3c88;
        --secondary-blue: #456E94;
        --tag-blue: #60a5fa;
        --tag-red: #f87171;
        --tag-yellow: #fbbf24;
        --white: #ffffff;
    }

    body {
        font-family: 'Kanit', sans-serif;
        margin: 0; 
        padding: 20px;
        min-height: 100vh;
        background-color: #cbdcf0;
        background-image: linear-gradient(#9fbfd6 1px, transparent 1px);
        background-size: 100% 35px;
        display: flex; 
        justify-content: center; 
        align-items: center;
    }

    .container { 
        width: 100%; 
        max-width: 850px; 
    }

    /* Multiplatform Card Design */
    .sheet-card {
        background-color: var(--card-bg);
        border-radius: 30px;
        padding: 40px;
        box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        display: flex; 
        flex-direction: row; 
        gap: 30px;
        position: relative;
    }

    .upload-section {
        flex: 0 0 160px;
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        padding-top: 10px;
    }

    .file-drop-area {
        width: 100%;
        max-width: 140px;
        height: 180px;
        background-color: var(--white);
        border: 2px dashed #ccc;
        border-radius: 20px;
        display: flex; 
        flex-direction: column;
        align-items: center; 
        justify-content: center;
        cursor: pointer; 
        transition: all 0.3s ease;
        text-align: center; 
        padding: 15px;
        color: #888; 
        font-size: 0.9rem;
        position: relative; 
        overflow: hidden;
    }
    .file-drop-area:hover { 
        border-color: var(--secondary-blue); 
        color: var(--secondary-blue);
        background-color: #f0f4f8;
    }
    .file-drop-area input[type="file"] { 
        position: absolute; 
        width: 100%; 
        height: 100%; 
        opacity: 0; 
        cursor: pointer; 
    }
    .file-icon { font-size: 45px; margin-bottom: 12px; }

    .info-section { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        gap: 20px; 
        min-width: 0; /* Prevent flex shrink issues */
    }

    .title-bubble {
        background-color: var(--primary-blue); 
        color: var(--white);
        padding: 12px 25px; 
        border-radius: 15px;
        position: relative; 
        font-weight: 500;
        width: 100%;
        box-sizing: border-box;
    }
    
    /* Speech bubble arrow only for desktop */
    @media (min-width: 601px) {
        .title-bubble::before {
            content: ''; 
            position: absolute; 
            left: -10px; 
            top: 50%; 
            transform: translateY(-50%);
            border-style: solid; 
            border-width: 10px 10px 10px 0;
            border-color: transparent var(--primary-blue) transparent transparent;
        }
    }

    input.title-input {
        background: transparent; 
        border: none; 
        color: var(--white);
        font-family: 'Kanit', sans-serif; 
        font-size: 1.1rem;
        font-weight: 500; 
        width: 100%; 
        outline: none;
    }
    input.title-input::placeholder { color: rgba(255,255,255,0.6); }

    .tags-row { 
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px; 
    }

    .custom-select-wrapper select {
        appearance: none; 
        border: none;
        padding: 10px 15px; 
        border-radius: 12px;
        font-family: 'Kanit', sans-serif; 
        font-size: 0.9rem;
        color: var(--white); 
        font-weight: 500; 
        cursor: pointer;
        outline: none; 
        width: 100%;
        transition: opacity 0.2s;
    }
    #subjectSelect { background-color: var(--tag-blue); }
    #professorSelect { background-color: var(--tag-red); }
    .custom-select-wrapper select:hover { opacity: 0.9; }

    textarea {
        width: 100%; 
        box-sizing: border-box; 
        background-color: var(--white); 
        border: 1px solid transparent; 
        border-radius: 15px; 
        padding: 15px; 
        font-family: 'Kanit', sans-serif; 
        font-size: 1rem;
        color: #333; 
        resize: none; 
        outline: none;
        min-height: 100px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        transition: 0.3s;
    }
    textarea:focus { border-color: var(--tag-blue); }

    .action-row { 
        display: flex; 
        justify-content: flex-end; 
    }

    button#uploadBtn {
        background-color: var(--tag-yellow); 
        color: #1f3c88; 
        border: none;
        padding: 12px 35px; 
        border-radius: 50px;
        font-family: 'Kanit', sans-serif; 
        font-weight: 600; 
        font-size: 1rem;
        cursor: pointer; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        transition: 0.3s;
    }
    button#uploadBtn:hover:not(:disabled) { 
        transform: translateY(-2px); 
        box-shadow: 0 6px 15px rgba(0,0,0,0.15); 
    }
    button#uploadBtn:disabled { background-color: #cbd5e1; cursor: not-allowed; color: #64748b; }

    /* Responsive Adjustments */
    @media (max-width: 600px) {
        body { padding: 15px; }
        .sheet-card { 
            flex-direction: column; 
            padding: 25px; 
            gap: 20px; 
            border-radius: 20px;
        }
        .upload-section { 
            flex: none; 
            width: 100%; 
            padding: 0;
        }
        .file-drop-area { 
            width: 100%; 
            max-width: none; 
            height: 120px; 
            flex-direction: row;
            gap: 15px;
        }
        .file-icon { font-size: 30px; margin: 0; }
        .tags-row { grid-template-columns: 1fr; }
        .action-row button { width: 100%; }
    }
</style>
</head>

<body>

<div class="container">
    <div class="sheet-card">
        <div class="upload-section">
            <div class="file-drop-area">
                <span class="file-icon">üìÑ</span>
                <span class="file-msg" id="fileNameDisplay">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (PDF)</span>
                <input type="file" id="pdfFile" accept="application/pdf">
            </div>
            <canvas id="coverCanvas" style="display:none;"></canvas>
        </div>

        <div class="info-section">
            <div class="title-wrapper">
                <div class="title-bubble">
                    <input type="text" id="sheetName" class="title-input" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...">
                </div>
            </div>

            <div class="tags-row">
                <div class="custom-select-wrapper">
                    <select id="subjectSelect">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                    </select>
                </div>
                <div class="custom-select-wrapper">
                    <select id="professorSelect">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô --</option>
                    </select>
                </div>
            </div>

            <div class="desc-wrapper">
                <textarea id="sheetDesc" rows="4" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ..."></textarea>
            </div>

            <div class="action-row">
                <button id="uploadBtn">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
            </div>
        </div>
    </div>
</div>

<script>
/* ================= PDF RENDERING LOGIC ================= */
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

async function generateCoverBlob(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
    const page = await pdf.getPage(1); 
    
    const canvas = document.getElementById('coverCanvas');
    const context = canvas.getContext('2d');
    const viewport = page.getViewport({ scale: 0.8 }); 

    canvas.height = viewport.height;
    canvas.width = viewport.width;

    await page.render({ canvasContext: context, viewport: viewport }).promise;
    
    return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
}

/* ================= UI EVENT LOGIC ================= */
document.getElementById('pdfFile').addEventListener('change', function(event) {
    const fileName = event.target.files[0]?.name;
    const display = document.getElementById('fileNameDisplay');
    if(fileName) {
        display.textContent = fileName.length > 20 ? fileName.substring(0, 17) + "..." : fileName;
        display.style.color = "#1f3c88"; 
        display.style.fontWeight = "500";
    } else {
        display.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (PDF)"; 
        display.style.color = "#888";
    }
});

/* ================= SUPABASE INTEGRATION ================= */
const supabaseClient = supabase.createClient(
    "https://ctfrqwehpvpldtiojedb.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0ZnJxd2VocHZwbGR0aW9qZWRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0OTk3NDgsImV4cCI6MjA4MjA3NTc0OH0.48CcrKn7QoBq5ao9ENyy_DSgJLf5ieybk1pLUVNQyO0"
)

const IDACC = sessionStorage.getItem("idacc");
const IDMAJOR = "M01"; 

const subjectSelect = document.getElementById("subjectSelect")
const professorSelect = document.getElementById("professorSelect")
const uploadBtn = document.getElementById("uploadBtn")

async function loadSubjects() {
    const { data, error } = await supabaseClient.from("Subject").select("idsubject, subject_name").order("subject_name")
    if (error) return;
    data.forEach(s => {
        const opt = document.createElement("option"); 
        opt.value = s.idsubject; 
        opt.textContent = s.subject_name;
        subjectSelect.appendChild(opt)
    })
}
loadSubjects()

subjectSelect.onchange = async () => {
    const idsubject = subjectSelect.value
    professorSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô --</option>`
    if (!idsubject) return;

    const { data, error } = await supabaseClient
        .from("professor_subject").select("idprofessor, Professor(name, surname)").eq("idsubject", idsubject)

    if (data) {
        data.forEach(p => {
            if(p.Professor) {
                const opt = document.createElement("option"); 
                opt.value = p.idprofessor;
                opt.textContent = `${p.Professor.name} ${p.Professor.surname}`; 
                professorSelect.appendChild(opt)
            }
        })
    }
}

uploadBtn.onclick = async () => {
    const file = document.getElementById("pdfFile").files[0]
    const sheetName = document.getElementById("sheetName").value.trim()
    const sheetDesc = document.getElementById("sheetDesc").value.trim()
    const idsubject = subjectSelect.value
    const idprofessor = professorSelect.value
    
    if (!file || !sheetName || !idsubject || !idprofessor) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); return;
    }

    uploadBtn.disabled = true; 
    uploadBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÑ‡∏ü‡∏•‡πå...";

    try {
        const timeStamp = Date.now();
        
        // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å
        const coverBlob = await generateCoverBlob(file);
        const coverPath = `sheet-cover/${IDACC}_${timeStamp}.png`;
        
        uploadBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å...";
        await supabaseClient.storage.from("sheet-pdf").upload(coverPath, coverBlob);
        const coverUrl = supabaseClient.storage.from("sheet-pdf").getPublicUrl(coverPath).data.publicUrl;

        // 2. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF
        uploadBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£...";
        const pdfPath = `sheets/${IDACC}_${timeStamp}.pdf`;
        const { error: pdfError } = await supabaseClient.storage.from("sheet-pdf").upload(pdfPath, file);
        if (pdfError) throw pdfError;

        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        uploadBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
        const { error: dbError } = await supabaseClient.from("Sheet").insert({
            sheet_name: sheetName,
            description: sheetDesc,
            file_path: pdfPath,
            sheet_cover: coverUrl,
            idacc: IDACC,
            idsubject: idsubject,
            idmajor: IDMAJOR,
            idprofessor: idprofessor
        });

        if (dbError) throw dbError;

        alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        location.href = "Allearn_profile.html";

    } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô: " + err.message);
        uploadBtn.disabled = false;
        uploadBtn.textContent = "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£";
    }
}
</script>

</body>
</html>