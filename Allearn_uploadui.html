<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <title>Allearn - ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ó</title>

<style>
    :root {
        --card-bg: #FFF9E5;
        --primary-blue: #456E94;
        --tag-blue: #60a5fa;
        --tag-red: #f87171;
        --tag-yellow: #fbbf24;
    }

    body {
        font-family: 'Kanit', sans-serif;
        margin: 0; padding: 40px 20px;
        min-height: 100vh;
        background-color: #cbdcf0;
        background-image: linear-gradient(#9fbfd6 1px, transparent 1px);
        background-size: 100% 35px;
        display: flex; justify-content: center; align-items: center;
    }

    .container { width: 100%; max-width: 800px; }

    .sheet-card {
        background-color: var(--card-bg);
        border-radius: 40px;
        padding: 40px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        display: flex; flex-direction: row; gap: 30px;
        position: relative;
    }

    .upload-section {
        flex: 0 0 150px;
        display: flex; flex-direction: column; align-items: center; padding-top: 20px;
    }
    .file-drop-area {
        width: 120px; height: 140px;
        background-color: #fff;
        border: 2px dashed #ccc;
        border-radius: 15px;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        cursor: pointer; transition: 0.3s;
        text-align: center; padding: 10px;
        color: #888; font-size: 0.9rem;
        position: relative; overflow: hidden;
    }
    .file-drop-area:hover { border-color: var(--primary-blue); color: var(--primary-blue); }
    .file-drop-area input[type="file"] { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .file-icon { font-size: 40px; margin-bottom: 10px; }

    .info-section { flex: 1; display: flex; flex-direction: column; gap: 15px; }

    .title-wrapper { display: flex; align-items: center; margin-bottom: 5px; }
    .title-bubble {
        background-color: var(--primary-blue); color: white;
        padding: 15px 30px; border-radius: 20px;
        position: relative; font-weight: 600; font-size: 1.2rem;
        width: 100%; display: flex; align-items: center;
    }
    .title-bubble::before {
        content: ''; position: absolute; left: -10px; top: 50%; transform: translateY(-50%);
        border-style: solid; border-width: 10px 10px 10px 0;
        border-color: transparent var(--primary-blue) transparent transparent;
    }
    input.title-input {
        background: transparent; border: none; color: white;
        font-family: 'Kanit', sans-serif; font-size: 1.2rem;
        font-weight: 600; width: 100%; outline: none;
    }
    input.title-input::placeholder { color: rgba(255,255,255,0.7); }

    .tags-row { display: flex; flex-wrap: wrap; gap: 10px; }
    .custom-select-wrapper { position: relative; }
    select {
        appearance: none; border: none;
        padding: 8px 30px 8px 15px; border-radius: 20px;
        font-family: 'Kanit', sans-serif; font-size: 0.9rem;
        color: white; font-weight: 500; cursor: pointer;
        outline: none; min-width: 120px;
    }
    select option { color: #333 !important; background-color: #fff !important; }
    #subjectSelect { background-color: var(--tag-blue); }
    #professorSelect { background-color: var(--tag-red); }

    .desc-wrapper { margin-top: 5px; }
    textarea {
        width: 100%; box-sizing: border-box; 
        background-color: #fff; border: 2px solid transparent; 
        border-radius: 20px; padding: 15px; 
        font-family: 'Kanit', sans-serif; font-size: 1rem;
        color: #333; resize: vertical; outline: none;
        min-height: 120px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.2s;
    }
    textarea:focus { border-color: var(--tag-blue); box-shadow: 0 4px 10px rgba(96, 165, 250, 0.2); }

    .action-row { display: flex; justify-content: flex-end; margin-top: 10px; }
    button#uploadBtn {
        background-color: var(--tag-yellow); color: #fff; border: none;
        padding: 10px 30px; border-radius: 20px;
        font-family: 'Kanit', sans-serif; font-weight: 600; font-size: 1rem;
        cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;
    }
    button#uploadBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 10px rgba(0,0,0,0.15); }
    button#uploadBtn:disabled { background-color: #ddd; cursor: not-allowed; }

    @media (max-width: 600px) {
        .sheet-card { flex-direction: column; padding: 20px; }
        .upload-section { width: 100%; flex-direction: row; justify-content: center; margin-bottom: 20px; }
    }
</style>
</head>

<body>

<div class="container">
    <div class="sheet-card">
        <div class="upload-section">
            <div class="file-drop-area">
                <span class="file-icon">üìÑ</span>
                <span class="file-msg" id="fileNameDisplay">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF</span>
                <input type="file" id="pdfFile" accept="application/pdf">
            </div>
            <canvas id="coverCanvas" style="display:none;"></canvas>
        </div>

        <div class="info-section">
            <div class="title-wrapper">
                <div class="title-bubble">
                    <input type="text" id="sheetName" class="title-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà...">
                </div>
            </div>

            <div class="tags-row">
                <div class="custom-select-wrapper">
                    <select id="subjectSelect">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                    </select>
                </div>
                <div class="custom-select-wrapper">
                    <select id="professorSelect">
                        <option value="">‡∏£‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤...</option>
                    </select>
                </div>
            </div>

            <div class="desc-wrapper">
                <textarea id="sheetDesc" rows="4" placeholder="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£? ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
            </div>

            <div class="action-row">
                <button id="uploadBtn">UPLOAD SHEET</button>
            </div>
        </div>
    </div>
</div>

<script>
/* ================= PDF LOGIC (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) ================= */
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

async function generateCoverBlob(file) {
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
    const page = await pdf.getPage(1); // ‡∏î‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ 1
    
    const canvas = document.getElementById('coverCanvas');
    const context = canvas.getContext('2d');
    const viewport = page.getViewport({ scale: 0.8 }); // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å

    canvas.height = viewport.height;
    canvas.width = viewport.width;

    await page.render({ canvasContext: context, viewport: viewport }).promise;
    
    return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
}

/* ================= UI LOGIC ================= */
document.getElementById('pdfFile').addEventListener('change', function(event) {
    const fileName = event.target.files[0]?.name;
    const display = document.getElementById('fileNameDisplay');
    if(fileName) {
        display.textContent = fileName.length > 15 ? fileName.substring(0, 12) + "..." : fileName;
        display.style.color = "#456E94"; display.style.fontWeight = "bold";
    } else {
        display.textContent = "‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF"; display.style.color = "#888";
    }
});

/* ================= SUPABASE LOGIC ================= */
const supabaseClient = supabase.createClient(
    "https://ctfrqwehpvpldtiojedb.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0ZnJxd2VocHZwbGR0aW9qZWRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0OTk3NDgsImV4cCI6MjA4MjA3NTc0OH0.48CcrKn7QoBq5ao9ENyy_DSgJLf5ieybk1pLUVNQyO0"
)

// ‡πÉ‡∏ä‡πâ IDACC ‡∏à‡∏≤‡∏Å Session ‡∏à‡∏£‡∏¥‡∏á‡∏à‡πâ‡∏≤
const IDACC = sessionStorage.getItem("idacc");
const IDMAJOR = "M01"; 

const subjectSelect = document.getElementById("subjectSelect")
const professorSelect = document.getElementById("professorSelect")
const uploadBtn = document.getElementById("uploadBtn")

async function loadSubjects() {
    const { data, error } = await supabaseClient.from("Subject").select("idsubject, subject_name").order("subject_name")
    if (error) return;
    data.forEach(s => {
        const opt = document.createElement("option"); opt.value = s.idsubject; opt.textContent = s.subject_name;
        subjectSelect.appendChild(opt)
    })
}
loadSubjects()

subjectSelect.onchange = async () => {
    const idsubject = subjectSelect.value
    professorSelect.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå --</option>`
    if (!idsubject) return;

    const { data, error } = await supabaseClient
        .from("professor_subject").select("idprofessor, Professor(name, surname)").eq("idsubject", idsubject)

    if (data) {
        data.forEach(p => {
            if(p.Professor) {
                const opt = document.createElement("option"); opt.value = p.idprofessor;
                opt.textContent = `${p.Professor.name} ${p.Professor.surname}`; 
                professorSelect.appendChild(opt)
            }
        })
    }
}

uploadBtn.onclick = async () => {
    const file = document.getElementById("pdfFile").files[0]
    const sheetName = document.getElementById("sheetName").value.trim()
    const sheetDesc = document.getElementById("sheetDesc").value.trim()
    const idsubject = subjectSelect.value
    const idprofessor = professorSelect.value
    
    if (!file || !sheetName || !idsubject || !idprofessor) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return;
    }

    uploadBtn.disabled = true; 
    uploadBtn.textContent = "Processing PDF...";

    try {
        const timeStamp = Date.now();
        const safeFileName = file.name.toLowerCase().replace(/[^a-z0-9]/g, "_");
        
        // 1. ‡πÄ‡∏à‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á PDF ‡∏à‡πâ‡∏≤
        const coverBlob = await generateCoverBlob(file);
        const coverPath = `sheet-cover/${IDACC}_${timeStamp}.png`; // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå sheet-cover
        
        uploadBtn.textContent = "Uploading Cover...";
        await supabaseClient.storage.from("sheet-pdf").upload(coverPath, coverBlob);
        const coverUrl = supabaseClient.storage.from("sheet-pdf").getPublicUrl(coverPath).data.publicUrl;

        // 2. ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡∏à‡∏£‡∏¥‡∏á
        uploadBtn.textContent = "Uploading PDF...";
        const pdfPath = `sheets/${IDACC}_${timeStamp}.pdf`; // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå sheets
        const { error: pdfError } = await supabaseClient.storage.from("sheet-pdf").upload(pdfPath, file);
        if (pdfError) throw pdfError;

        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Sheet
        uploadBtn.textContent = "Saving to Database...";
        const { error: dbError } = await supabaseClient.from("Sheet").insert({
            sheet_name: sheetName,
            description: sheetDesc,
            file_path: pdfPath,
            sheet_cover: coverUrl, // ‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏ô‡πÑ‡∏î‡πâ‡∏à‡πä‡∏∞
            idacc: IDACC,
            idsubject: idsubject,
            idmajor: IDMAJOR,
            idprofessor: idprofessor
        });

        if (dbError) throw dbError;

        alert("‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏µ‡∏ó‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
        location.href = "Allearn_profile.html";

    } catch (err) {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
        uploadBtn.disabled = false;
        uploadBtn.textContent = "UPLOAD SHEET";
    }
}
</script>

</body>
</html>